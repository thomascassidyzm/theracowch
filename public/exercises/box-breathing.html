<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0C0A09">
    <title>Box Breathing - Cowch</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0C0A09;
            --text: #E7E5E4;
            --text-muted: #78716C;
            --breath: #E07A5F;
            --breath-dim: rgba(224, 122, 95, 0.3);
            --breath-glow: rgba(224, 122, 95, 0.4);
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Gabarito', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            min-height: 100dvh;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }

        /* ====== THE BOX AREA ====== */
        .box-area {
            position: relative;
            width: min(280px, 70vw);
            height: min(280px, 70vw);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Inner breathing shape - scales up to fill the frame */
        .breath-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: scale(0.4);
            transition: transform 0.1s linear;
            background: radial-gradient(
                circle at 30% 30%,
                rgba(224, 122, 95, 0.15) 0%,
                rgba(224, 122, 95, 0.08) 50%,
                rgba(224, 122, 95, 0.03) 80%,
                transparent 100%
            );
            border-radius: 12px;
            pointer-events: none;
        }

        /* Fixed outer frame - always full size */
        .box-frame {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* Edge tracks (the dim background line) - FIXED at full size */
        .edge-track {
            position: absolute;
            background: var(--breath-dim);
        }

        .edge-track.top {
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .edge-track.right {
            top: 0;
            right: 0;
            bottom: 0;
            width: 4px;
        }

        .edge-track.bottom {
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .edge-track.left {
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
        }

        /* Progress bars (the bright moving line) */
        .edge-progress {
            position: absolute;
            background: var(--breath);
            box-shadow: 0 0 12px var(--breath), 0 0 24px var(--breath-glow);
        }

        .edge-track.top .edge-progress {
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
        }

        .edge-track.right .edge-progress {
            top: 0;
            right: 0;
            width: 100%;
            height: 0%;
        }

        .edge-track.bottom .edge-progress {
            bottom: 0;
            right: 0;
            height: 100%;
            width: 0%;
        }

        .edge-track.left .edge-progress {
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
        }

        /* Tick marks - subtle second indicators */
        .tick-marks {
            position: absolute;
            z-index: 1;
        }

        .tick-marks.horizontal {
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            display: flex;
            justify-content: space-between;
            padding: 0 25%;
        }

        .tick-marks.horizontal.bottom {
            top: auto;
            bottom: 0;
        }

        .tick-marks.vertical {
            top: 0;
            bottom: 0;
            width: 4px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 25% 0;
        }

        .tick-marks.vertical.left {
            left: 0;
        }

        .tick-marks.vertical.right {
            right: 0;
        }

        .tick {
            width: 2px;
            height: 100%;
            background: rgba(12, 10, 9, 0.6);
        }

        .tick-marks.vertical .tick {
            width: 100%;
            height: 2px;
        }

        /* Corner dots - FIXED at full size */
        .corner {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--breath-dim);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .corner.active {
            background: var(--breath);
            box-shadow: 0 0 16px var(--breath);
            transform: translate(-50%, -50%) scale(1.2);
        }

        .corner.tl { top: 0; left: 0; }
        .corner.tr { top: 0; left: 100%; }
        .corner.br { top: 100%; left: 100%; }
        .corner.bl { top: 100%; left: 0; }

        /* Side labels - outside the box area */
        .side-label {
            position: absolute;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            opacity: 0.4;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .side-label.active {
            color: var(--breath);
            opacity: 1;
        }

        .side-label.top { top: -2.5rem; left: 50%; transform: translateX(-50%); }
        .side-label.right { right: -2.5rem; top: 50%; transform: translateY(-50%); }
        .side-label.bottom { bottom: -2.5rem; left: 50%; transform: translateX(-50%); }
        .side-label.left { left: -2.5rem; top: 50%; transform: translateY(-50%); }

        /* Center content */
        .center-content {
            position: relative;
            z-index: 10;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            pointer-events: none;
        }

        .phase-word {
            font-size: clamp(2rem, 8vw, 3rem);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .phase-word.visible {
            opacity: 1;
        }

        .countdown {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--breath);
            letter-spacing: 0.1em;
        }

        .start-instruction {
            font-size: clamp(1rem, 4vw, 1.25rem);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text);
            pointer-events: auto;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .start-instruction:hover {
            color: var(--breath);
        }

        .start-instruction.hidden {
            display: none;
        }

        /* ====== CONTROLS ====== */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .duration-select {
            display: flex;
            gap: 0.5rem;
        }

        .duration-btn {
            background: transparent;
            border: 2px solid var(--text-muted);
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 700;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .duration-btn:hover {
            border-color: var(--text);
            color: var(--text);
        }

        .duration-btn.active {
            background: var(--text);
            border-color: var(--text);
            color: var(--bg);
        }

        .hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .hint.hidden {
            visibility: hidden;
        }

        /* ====== OVERLAYS ====== */
        .overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            z-index: 100;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .pause-overlay {
            background: rgba(12, 10, 9, 0.95);
        }

        .overlay-title {
            font-size: clamp(2rem, 6vw, 3rem);
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .overlay-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .session-summary {
            display: flex;
            gap: 3rem;
            margin-bottom: 2rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--breath);
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .overlay-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            background: transparent;
            border: 3px solid var(--text-muted);
            border-radius: 16px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .btn:hover {
            border-color: var(--text);
            color: var(--text);
            transform: translateY(-2px);
        }

        .btn.primary {
            background: var(--breath);
            border-color: var(--breath);
            color: var(--bg);
        }

        .btn.primary:hover {
            box-shadow: 4px 4px 0 0 var(--breath-glow);
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (prefers-reduced-motion: reduce) {
            .breath-fill, .corner, .side-label, .phase-word {
                transition: none;
            }
        }
    </style>
</head>
<body>
    <div id="announcer" class="sr-only" role="status" aria-live="polite"></div>

    <div class="container">
        <div class="box-area" id="boxArea">
            <!-- Inner breathing fill - scales -->
            <div class="breath-fill" id="breathFill"></div>

            <!-- Fixed outer frame with edge timers -->
            <div class="box-frame">
                <!-- Edge tracks with progress -->
                <div class="edge-track top">
                    <div class="tick-marks horizontal">
                        <span class="tick"></span>
                        <span class="tick"></span>
                        <span class="tick"></span>
                    </div>
                    <div class="edge-progress" id="progress-top"></div>
                </div>
                <div class="edge-track right">
                    <div class="tick-marks vertical right">
                        <span class="tick"></span>
                        <span class="tick"></span>
                        <span class="tick"></span>
                    </div>
                    <div class="edge-progress" id="progress-right"></div>
                </div>
                <div class="edge-track bottom">
                    <div class="tick-marks horizontal bottom">
                        <span class="tick"></span>
                        <span class="tick"></span>
                        <span class="tick"></span>
                    </div>
                    <div class="edge-progress" id="progress-bottom"></div>
                </div>
                <div class="edge-track left">
                    <div class="tick-marks vertical left">
                        <span class="tick"></span>
                        <span class="tick"></span>
                        <span class="tick"></span>
                    </div>
                    <div class="edge-progress" id="progress-left"></div>
                </div>

                <!-- Corners -->
                <div class="corner tl" data-corner="0"></div>
                <div class="corner tr" data-corner="1"></div>
                <div class="corner br" data-corner="2"></div>
                <div class="corner bl" data-corner="3"></div>
            </div>

            <!-- Labels outside box area -->
            <span class="side-label top">IN</span>
            <span class="side-label right">HOLD</span>
            <span class="side-label bottom">OUT</span>
            <span class="side-label left">HOLD</span>

            <!-- Center text -->
            <div class="center-content">
                <span class="start-instruction" id="startInstruction">TAP TO BEGIN</span>
                <span class="phase-word" id="phaseWord">IN</span>
                <span class="countdown" id="countdown" style="display: none;">4</span>
            </div>
        </div>

        <div class="controls">
            <div class="duration-select" id="durationSelect">
                <button class="duration-btn" data-minutes="2">2 min</button>
                <button class="duration-btn active" data-minutes="5">5 min</button>
                <button class="duration-btn" data-minutes="10">10 min</button>
            </div>
            <span class="hint" id="hint">tap to pause</span>
        </div>
    </div>

    <!-- Pause Overlay -->
    <div class="overlay pause-overlay" id="pauseOverlay">
        <h2 class="overlay-title">Paused</h2>
        <div class="overlay-actions">
            <button class="btn" id="endSessionBtn">End</button>
            <button class="btn primary" id="resumeBtn">Continue</button>
        </div>
    </div>

    <!-- End Overlay -->
    <div class="overlay" id="endOverlay">
        <h2 class="overlay-title">Well Done</h2>
        <p class="overlay-subtitle">Take this calm with you</p>
        <div class="session-summary">
            <div class="summary-item">
                <div class="summary-value" id="finalMinutes">5</div>
                <div class="summary-label">Minutes</div>
            </div>
            <div class="summary-item">
                <div class="summary-value" id="finalCycles">0</div>
                <div class="summary-label">Cycles</div>
            </div>
        </div>
        <div class="overlay-actions">
            <button class="btn" id="homeBtn">Home</button>
            <button class="btn primary" id="againBtn">Again</button>
        </div>
    </div>

    <script>
        const PHASE_DURATION = 4000;
        const SCALE_MIN = 0.4;
        const SCALE_MAX = 1.0;

        const PHASES = [
            { name: 'IN', edge: 'top', corner: 0, action: 'expand' },
            { name: 'HOLD', edge: 'right', corner: 1, action: 'hold-full' },
            { name: 'OUT', edge: 'bottom', corner: 2, action: 'contract' },
            { name: 'HOLD', edge: 'left', corner: 3, action: 'hold-empty' }
        ];

        const state = {
            duration: 5 * 60 * 1000,
            elapsed: 0,
            phase: 0,
            cycles: 0,
            countdown: 4,
            isPaused: false,
            isRunning: false,
            phaseStartTime: null,
            lastTick: null,
            animationId: null,
            scale: SCALE_MIN
        };

        // DOM
        const boxArea = document.getElementById('boxArea');
        const breathFill = document.getElementById('breathFill');
        const startInstruction = document.getElementById('startInstruction');
        const phaseWord = document.getElementById('phaseWord');
        const countdownEl = document.getElementById('countdown');
        const durationSelect = document.getElementById('durationSelect');
        const hint = document.getElementById('hint');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const endOverlay = document.getElementById('endOverlay');
        const announcer = document.getElementById('announcer');

        const progressBars = {
            top: document.getElementById('progress-top'),
            right: document.getElementById('progress-right'),
            bottom: document.getElementById('progress-bottom'),
            left: document.getElementById('progress-left')
        };

        const corners = document.querySelectorAll('.corner');
        const sideLabels = document.querySelectorAll('.side-label');

        // Duration buttons
        document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (state.isRunning) return;
                document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.duration = parseInt(btn.dataset.minutes) * 60 * 1000;
            });
        });

        // Start/pause on box click
        boxArea.addEventListener('click', () => {
            if (!state.isRunning) {
                startSession();
            } else if (!state.isPaused) {
                pauseSession();
            }
        });

        // Overlay buttons
        document.getElementById('resumeBtn').addEventListener('click', resumeSession);
        document.getElementById('endSessionBtn').addEventListener('click', endSession);
        document.getElementById('againBtn').addEventListener('click', resetToStart);
        document.getElementById('homeBtn').addEventListener('click', () => {
            window.location.href = '/app.html#imagine';
        });

        function announce(msg) {
            announcer.textContent = msg;
        }

        function setScale(scale) {
            state.scale = scale;
            breathFill.style.transform = `scale(${scale})`;
        }

        function startSession() {
            state.elapsed = 0;
            state.phase = 0;
            state.cycles = 0;
            state.countdown = 4;
            state.isPaused = false;
            state.isRunning = true;

            startInstruction.classList.add('hidden');
            phaseWord.classList.add('visible');
            countdownEl.style.display = 'block';
            durationSelect.style.opacity = '0.3';
            durationSelect.style.pointerEvents = 'none';
            hint.classList.remove('hidden');

            setScale(SCALE_MIN);
            resetAllProgress();
            updatePhase();

            state.phaseStartTime = performance.now();
            state.lastTick = performance.now();
            tick();

            announce('Breathing started. Breathe in.');
        }

        function tick() {
            if (!state.isRunning) return;

            const now = performance.now();

            if (!state.isPaused) {
                state.elapsed += now - state.lastTick;

                if (state.elapsed >= state.duration) {
                    completeSession();
                    return;
                }

                const phaseElapsed = now - state.phaseStartTime;
                const progress = Math.min(1, phaseElapsed / PHASE_DURATION);

                updateEdgeProgress(progress);
                updateScale(progress);

                const newCountdown = Math.max(1, 4 - Math.floor(phaseElapsed / 1000));
                if (newCountdown !== state.countdown) {
                    state.countdown = newCountdown;
                    countdownEl.textContent = state.countdown;
                }

                if (progress >= 1) {
                    nextPhase();
                    state.phaseStartTime = now;
                }
            }

            state.lastTick = now;
            state.animationId = requestAnimationFrame(tick);
        }

        function updateEdgeProgress(progress) {
            const edge = PHASES[state.phase].edge;
            const bar = progressBars[edge];
            const pct = (progress * 100) + '%';

            if (edge === 'top' || edge === 'bottom') {
                bar.style.width = pct;
            } else {
                bar.style.height = pct;
            }
        }

        function updateScale(progress) {
            const action = PHASES[state.phase].action;
            let newScale;

            switch (action) {
                case 'expand':
                    newScale = SCALE_MIN + (SCALE_MAX - SCALE_MIN) * progress;
                    break;
                case 'hold-full':
                    newScale = SCALE_MAX;
                    break;
                case 'contract':
                    newScale = SCALE_MAX - (SCALE_MAX - SCALE_MIN) * progress;
                    break;
                case 'hold-empty':
                    newScale = SCALE_MIN;
                    break;
                default:
                    newScale = state.scale;
            }

            setScale(newScale);
        }

        function resetAllProgress() {
            Object.values(progressBars).forEach(bar => {
                bar.style.width = '0%';
                bar.style.height = '0%';
            });
        }

        function updatePhase() {
            const phase = PHASES[state.phase];

            // Reset progress bars
            resetAllProgress();

            // Update corners
            corners.forEach(c => c.classList.remove('active'));
            corners[phase.corner].classList.add('active');

            // Update labels
            sideLabels.forEach(l => l.classList.remove('active'));
            document.querySelector(`.side-label.${phase.edge}`).classList.add('active');

            // Update word
            phaseWord.classList.remove('visible');
            setTimeout(() => {
                phaseWord.textContent = phase.name;
                phaseWord.classList.add('visible');
            }, 100);

            state.countdown = 4;
            countdownEl.textContent = '4';

            if (navigator.vibrate) navigator.vibrate(15);

            announce(phase.name === 'IN' ? 'Breathe in' : phase.name === 'OUT' ? 'Breathe out' : 'Hold');
        }

        function nextPhase() {
            state.phase = (state.phase + 1) % PHASES.length;
            if (state.phase === 0) state.cycles++;
            updatePhase();
        }

        function pauseSession() {
            state.isPaused = true;
            pauseOverlay.classList.add('active');
            announce('Paused');
        }

        function resumeSession() {
            state.isPaused = false;
            state.phaseStartTime = performance.now() - ((4 - state.countdown) * 1000);
            state.lastTick = performance.now();
            pauseOverlay.classList.remove('active');
            announce('Resumed');
        }

        function endSession() {
            state.isRunning = false;
            cancelAnimationFrame(state.animationId);
            pauseOverlay.classList.remove('active');

            document.getElementById('finalMinutes').textContent = Math.round(state.elapsed / 60000) || '<1';
            document.getElementById('finalCycles').textContent = state.cycles;

            endOverlay.classList.add('active');
            announce('Session ended');
        }

        function completeSession() {
            state.isRunning = false;
            cancelAnimationFrame(state.animationId);

            document.getElementById('finalMinutes').textContent = Math.round(state.elapsed / 60000);
            document.getElementById('finalCycles').textContent = state.cycles;

            localStorage.setItem('boxBreathingSessions',
                (parseInt(localStorage.getItem('boxBreathingSessions') || 0) + 1).toString());

            endOverlay.classList.add('active');
            announce('Complete. Well done.');
        }

        function resetToStart() {
            endOverlay.classList.remove('active');

            startInstruction.classList.remove('hidden');
            phaseWord.classList.remove('visible');
            phaseWord.textContent = 'IN';
            countdownEl.style.display = 'none';
            durationSelect.style.opacity = '1';
            durationSelect.style.pointerEvents = 'auto';
            hint.classList.add('hidden');

            setScale(SCALE_MIN);
            resetAllProgress();
            corners.forEach(c => c.classList.remove('active'));
            sideLabels.forEach(l => l.classList.remove('active'));

            state.isRunning = false;
            state.isPaused = false;
            state.phase = 0;
            state.cycles = 0;
            state.elapsed = 0;
        }

        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (!state.isRunning) startSession();
                else if (state.isPaused) resumeSession();
                else pauseSession();
            }
            if (e.code === 'Escape' && state.isRunning) {
                state.isPaused ? endSession() : pauseSession();
            }
        });

        hint.classList.add('hidden');
    </script>
</body>
</html>
